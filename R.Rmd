---
title: "R Notebook"
output: html_notebook
---
#testing things out
Installing packages
```{r}
install.packages("tidyverse")
library(tidyverse)
```

Plot of mean annual precipitation and age using baad_with_map data
```{r}
ggplot(baad_with_map, aes(mean_annual_precipitation, age, colour=vegetation)) + geom_point()
```

Plot of mean annual precipitation and height using baad_with_map data
```{r}
ggplot(baad_with_map, aes(mean_annual_precipitation, h.t)) + geom_point()
```

Plot of mean annual precipitation and height with colours meaning growing condition using baad_with_map data
```{r}
ggplot(baad_with_map, aes(mean_annual_precipitation, h.t, colour=growingCondition)) + geom_point()
```

Plot of mean annual precipitation and latitude using baad_with_map data
```{r}
ggplot(baad_with_map, aes(mean_annual_precipitation, latitude)) + geom_point()
```

Plot of latitude and age using baad_with_map data
```{r}
ggplot(baad_with_map, aes(latitude, age)) + geom_point()
```

Plot of latitude and height using baad_with_map data
```{r}
ggplot(baad_with_map, aes(latitude, h.t)) + geom_point()
```

Summarizing what i need to do before i can make the map for the species
```{r}
baad_with_map %>%
  group_by(species) %>%
  summarize(sample_size=n()) %>%
  arrange(desc(sample_size))
```

World map with species as points
```{r}
leaflet(data = baad_with_map) %>%
    addTiles() %>%
    addCircleMarkers(lat = ~latitude, lng = ~longitude,popup = ~species)
```

Making each species a different colour on the map 
```{r}
pal <- colorFactor(  palette = 'Dark2',  
                     domain = baad_with_map$studyName)
leaflet(data = baad_with_map) %>%  
  addTiles() %>%  
  addCircleMarkers(lat = ~latitude, lng = ~longitude,popup = ~species, color=~pal(studyName))
```

#what Will did 
Loading tree height data this creates a map of the height heights of the world using Scheffer data
```{r}
library(raster)

tree_height<-raster("data/Scheffer_2018/90th_percentile_height.tif")
plot(tree_height)
```

Cropping to just Australia, first two numbers are the top left hand corner on a map lat and long and the second two are the bottom lat and long (used google maps to find the points)
```{r}
australia<-extent(c(111, 158, -44, -9.6))
tree_aus <- crop(tree_height,australia)
plot(tree_aus)
```

Extract data, so you're getting data of the tree heights with the x and y coordinates 
```{r}
library(tidyverse)
df<-tibble(
  tree_height=getValues(tree_aus)
)
xy<-coordinates(tree_aus)
df<-cbind(df,xy)
```

Making world map of the annual precip 
```{r}
prec<-getData('worldclim', var='prec', res=10)
map<-sum(prec)
plot(map)
```

getting the wind data
```{r}
wind_filenames<-list.files("wc2.1_10m_wind",full.names = T)
wind<-stack(wind_filenames)
average_wind<-mean(wind)
```

getting the solar radiation data
```{r}
solar_filenames<-list.files("wc2.1_10m_srad",full.names = T)
solar<-stack(solar_filenames)
average_solar<-mean(solar)
```

getting the average temperature data
```{r}
temperature_filenames<-list.files("wc2.1_10m_tavg",full.names = T)
temperature<-stack(temperature_filenames)
average_temperature<-mean(temperature)
```

getting the water vapor data
```{r}
vapor_filenames<-list.files("wc2.1_10m_vapr",full.names = T)
vapor<-stack(vapor_filenames)
average_vapor<-mean(vapor)
```

getting the minimum temp data
```{r}
tmin_filenames<-list.files("wc2.1_10m_tmin",full.names = T)
min_t<-stack(tmin_filenames)
minimum_temp<-mean(min_t)
```

getting the maximmum temp data
```{r}
tmax_filenames<-list.files("wc2.1_10m_tmax",full.names = T)
max_t<-stack(tmax_filenames)
maximum_temp<-mean(max_t)
```


```{r}
df <-mutate(df, annual_precip=raster::extract(map,xy),
            wind_speed=raster::extract(average_wind,xy), 
            solar_radiation=raster::extract(average_solar,xy),
            temperature_average=raster::extract(average_temperature,xy),
            water_vapor=raster::extract(average_vapor, xy), 
            min_temp=raster::extract(minimum_temp, xy),
            max_temp=raster::extract(maximum_temp,xy))
```

Scatter plot of annual precip vs tree height in Australia annual_precip
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=annual_precip,y=tree_height))+geom_point()
```

wind_speed scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=wind_speed,y=tree_height))+geom_point()
```

solar_radiation scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=solar_radiation,y=tree_height))+geom_point() +geom_smooth(method="lm")
```

temperature_average scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=temperature_average,y=tree_height))+geom_point()
```

water_vapor scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=water_vapor,y=tree_height))+geom_point()+geom_smooth(method="lm")
```

min_temp scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=min_temp,y=tree_height))+geom_point()+geom_smooth(method="lm")
```

max_temp scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=water_vapor,y=tree_height))+geom_point()+geom_smooth(method="lm")
```

linear models of each variable by themselves 
```{r}
df2<-filter(df,tree_height>0)

a <- lm(log10(tree_height)~annual_precip,data=df2)
b <- lm(log10(tree_height)~wind_speed,data=df2)
c <- lm(log10(tree_height)~solar_radiation, data = df2)
d <- lm(log10(tree_height)~temperature_average, data = df2)
e <- lm(log10(tree_height)~water_vapor, data = df2)
mit<- lm(log10(tree_height)~min_temp,data = df2)
mat <- lm(log10(tree_height)~max_temp,data = df2)
```

getting summary stuff for the model
```{r}
library(parameters)
library(performance)
model_parameters(mat)
r2(mat)
summary(mat)
```

```{r}
AIC(a,b,c,d,e,mit,mat)
```

testing different models with different variables 
```{r}
f <- lm(log10(tree_height)~annual_precip*wind_speed,data=df2)
g <- lm(log10(tree_height)~annual_precip+wind_speed,data=df2)
h <- lm(log10(tree_height)~annual_precip+solar_radiation,data=df2)
i <- lm(log10(tree_height)~annual_precip*solar_radiation,data=df2)
j <- lm(log10(tree_height)~annual_precip+water_vapor,data=df2)
k <- lm(log10(tree_height)~annual_precip*water_vapor,data=df2)
l <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation,data=df2)
m <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*max_temp,data=df2)
n <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*max_temp*temperature_average,data=df2) 
o <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*max_temp*temperature_average*min_temp,data=df2)
p <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*max_temp*temperature_average*min_temp*wind_speed,data=df2)
```

```{r}
AIC(i,j,k, l,m,n,o,p)
```

```{r}
step(i)
```

make data complete with no NA's
```{r}
df3 <- filter(df2,!is.na(annual_precip))
```

run model
```{r}
model <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*max_temp*temperature_average*min_temp*wind_speed,data=df3)
```

get out predictions
```{r}
df3$predicted_height<-predict(model)
```

put predictions back in spatial context
```{r}
z <- rasterize(x=cbind(df3$x,df3$y),y=tree_aus,
          field=df3$predicted_height,fun=mean)
```

plot
```{r}
plot(z)
plot(log10(tree_aus))
plot(tree_aus)
```

trying quantile regression on the best linear model 
```{r}
ld <- ggplot(df3, aes(tree_height, annual_precip*water_vapor*solar_radiation*max_temp*temperature_average*min_temp*wind_speed)) + geom_point()
ld + geom_quantile()
```

```{r}
ld + geom_quantile(quantiles = 0.5)
```

#first blog: https://www.r-bloggers.com/quantile-regression-in-r-2/
Trying quantile regression just tree height and annual precip 
```{r}
install.packages("quantreg")
```

```{r}
library(quantreg)
```

Doing first blog
```{r}
rqfit <- rq(tree_height ~ annual_precip, data = df)
rqfit
```

Doing first blog
```{r}
summary(rqfit)
```

Doing first blog + I filtered out the NAs!!!
quantile regression line in blue and the linear regression line in red, tau is 0.5
```{r}
filter(df,tree_height>0 & annual_precip>0)
df1 <- df %>%
  filter(
    tree_height>0 &
    annual_precip>0
  )
plot(tree_height ~ annual_precip, data=df1, pch = 16, main = "tree_height ~ annual_precip")
abline(lm(tree_height ~ annual_precip, data = df1), col = "red", lty = 2)
abline(rq(tree_height ~ annual_precip, data = df1), col = "blue", lty = 2)
legend("topright", legend = c("lm", "rq"), col = c("red", "blue"), lty = 2)
```

just looking at the effect of outliers, non dotted lines are the new ones, see how linear is affected and quantile isnt
```{r}
y <- c(df1$tree_height, 0.1, 39)
x <- c(df1$annual_precip, 2999, 450)
plot(y ~ x, pch = 16, main = "tree_height ~ annual_precip")
points(c(2999, 450), c(0.1, 39), pch = 16, col = "dark orange")
abline(lm(tree_height ~ annual_precip, data = df1), col = "red", lty = 2)
abline(lm(y ~ x), col = "red")
abline(rq(tree_height ~ annual_precip, data = df1), col = "blue", lty = 2)
abline(rq(y ~ x), col = "blue")
```

shows precip
```{r}
multi_rqfit <- rq(tree_height ~ annual_precip, data = df1, tau = seq(0, 1, by = 0.1))
multi_rqfit
```
shows tree height 
```{r}
multi_rqfit <- rq(annual_precip~tree_height, data = df1, tau = seq(0, 1, by = 0.1))
multi_rqfit
```

```{r}
colours <- c("#ffe6e6", "#ffcccc", "#ff9999", "#ff6666", "#ff3333",
            "#ff0000", "#cc0000", "#b30000", "#800000", "#4d0000", "#000000")
plot(tree_height ~ annual_precip, data = df1, pch = 16, main = "tree_height ~ annual_precip")
for (j in 1:ncol(multi_rqfit$coefficients)) {
    abline(coef(multi_rqfit)[, j], col = colours[j])
}
```

```{r}
summary(rq(tree_height ~ annual_precip, data=df1, tau = 0.5), se = "boot", bsmethod= "xy")

```

#using a different website
https://ggplot2.tidyverse.org/reference/geom_quantile.html
```{r}
install.packages("ggplot2")
library(ggplot2)
```

pretty sure this is tau= 0.25, 0.5, 0.95
```{r}
m <- ggplot(df1, aes(annual_precip, tree_height)) + geom_point()
m + geom_quantile()
```

tau is 0.5
```{r}
m + geom_quantile(quantiles = 0.5)
```

tau is 0.95
```{r}
m + geom_quantile(quantiles = 0.95)
```

```{r}
q10 <- seq(0.05, 0.95, by = 0.05)
m + geom_quantile(quantiles = q10)
```


