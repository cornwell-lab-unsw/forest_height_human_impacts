---
title: "R Notebook"
output: html_notebook
---

```{r, results='hide'}
library(raster)
library(sp)
library(raster)
library(tidyverse)
library(parameters)
library(performance)
library(quantreg)
```

### Map of actual forest height Australia
After loading Scheffer et al. (2018) data set, we created a map of the tree height distribution around the world.
```{r}
tree_height<-raster("data/Scheffer_2018/90th_percentile_height.tif")
plot(tree_height)
```

We then cropped the world map of tree height just to Australia, by calculating the latitude and longitude around Australia.
```{r}
australia<-extent(c(111, 158, -44, -9.6))
tree_aus <- crop(tree_height,australia)
plot(tree_aus)
```

We then extracted the data from the world map of tree height distribution.
```{r}
df<-tibble(
  tree_height=getValues(tree_aus)
)
xy<-coordinates(tree_aus)
df<-cbind(df,xy)
```


## Map of predicted forest height in Australia
We loaded the global annual precipitation data from WorldClim and created a map of the results. 
```{r}
prec<-getData('worldclim', var='prec', res=10)
map<-sum(prec)
plot(map)
```

We loaded the global annual wind speed data from WorldClim and stacked the 12 sets of data together representing the 12 months of the year.
```{r}
wind_filenames<-list.files("wc2.1_10m_wind",full.names = T)
wind<-stack(wind_filenames)
average_wind<-mean(wind)
```

We loaded the global annual solar radiation data from WorldClim and stacked the 12 sets of data together representing the 12 months of the year.
```{r}
solar_filenames<-list.files("wc2.1_10m_srad",full.names = T)
solar<-stack(solar_filenames)
average_solar<-mean(solar)
```

We loaded the global annual average temperature data from WorldClim and stacked the 12 sets of data together representing the 12 months of the year.
```{r}
temperature_filenames<-list.files("wc2.1_10m_tavg",full.names = T)
temperature<-stack(temperature_filenames)
average_temperature<-mean(temperature)
```

We loaded the global annual water vapour data from WorldClim and stacked the 12 sets of data together representing the 12 months of the year.
```{r}
vapor_filenames<-list.files("wc2.1_10m_vapr",full.names = T)
vapor<-stack(vapor_filenames)
average_vapor<-mean(vapor)
```

getting the minimum temp data
```{r}
tmin_filenames<-list.files("wc2.1_10m_tmin",full.names = T)
min_t<-stack(tmin_filenames)
minimum_temp<-mean(min_t)
```

getting the maximmum temp data
```{r}
tmax_filenames<-list.files("wc2.1_10m_tmax",full.names = T)
max_t<-stack(tmax_filenames)
maximum_temp<-mean(max_t)
```

We then imported clay soil data from ---.
```{r}
clay <- read_csv("clay1.csv")
```

We then filtered out the NAs from the data. 
```{r}
clay_clean <- filter(clay,!is.na(clay))
```

We then turned the csv to a rasterbrick
```{r}
clay_raster <- rasterize(x=cbind(clay_clean$x,clay_clean$y),y=tree_aus, field=clay_clean, fun=mean)
```

Converted to a rasterlayer
```{r}
clay_pls <- raster(clay_raster)
```

We the cropped each of the predictors to the coordinates of Australia, to create a data set including all the predictors.
```{r}
df <-mutate(df, annual_precip=raster::extract(map,xy),
            wind_speed=raster::extract(average_wind,xy), 
            solar_radiation=raster::extract(average_solar,xy),
            temperature_average=raster::extract(average_temperature,xy),
            water_vapor=raster::extract(average_vapor, xy), 
            min_temp=raster::extract(minimum_temp, xy),
            max_temp=raster::extract(maximum_temp,xy))
```

```{r}
df <-mutate(df, annual_precip=raster::extract(map,xy),
            wind_speed=raster::extract(average_wind,xy), 
            solar_radiation=raster::extract(average_solar,xy),
            temperature_average=raster::extract(average_temperature,xy),
            water_vapor=raster::extract(average_vapor, xy), 
            min_temp=raster::extract(minimum_temp, xy),
            max_temp=raster::extract(maximum_temp,xy),
            clay_data=raster::extract(clay_pls,xy))
```

We then created a scatter plot comparing the Australian annual precipitation to the Australian distribution of tree height.
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=annual_precip,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

We then created a scatter plot comparing the Australian annual wind speed to the Australian distribution of tree height. 
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=wind_speed,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

We then created a scatter plot comparing the Australian annual solar radiation to the Australian distribution of tree height.
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=solar_radiation,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

We then created a scatter plot comparing the Australian annual average temperature to the Australian distribution of tree height.
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=temperature_average,y=tree_height))+geom_point() + geom_smooth(method="lm")
```

We then created a scatter plot comparing the Australian annual water vapour to the Australian distribution of tree height.
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=water_vapor,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

min_temp scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=min_temp,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

max_temp scatterplot
```{r}
filter(df,tree_height>0) %>%
ggplot(aes(x=water_vapor,y=tree_height)) + geom_point() + geom_smooth(method="lm")
```

We then filtered out the NA tree height values. 
```{r}
df2<-filter(df,tree_height>0)
```

We then created linear models of each predictor with tree height logged. 
```{r}
a <- lm(log10(tree_height)~annual_precip,data=df2)
b <- lm(log10(tree_height)~wind_speed,data=df2)
c <- lm(log10(tree_height)~solar_radiation, data = df2)
d <- lm(log10(tree_height)~temperature_average, data = df2)
e <- lm(log10(tree_height)~water_vapor, data = df2)
mit<- lm(log10(tree_height)~min_temp,data = df2)
mat <- lm(log10(tree_height)~max_temp,data = df2)
```

We then looked at the getting summary of each predictor.
```{r}
model_parameters(mat)
r2(mat)
summary(mat)
```

We then completed an Akaike's An Information Criterion on each of the linear models of each predictor. 
```{r}
AIC(a,b,c,d,e,mit,mat)
```

We then tried different models with different information to discover what model was most successful.
```{r}
i <- lm(log10(tree_height)~annual_precip*solar_radiation,data=df2)
j <- lm(log10(tree_height)~annual_precip*solar_radiation*water_vapor,data=df2)
k <- lm(log10(tree_height)~annual_precip*solar_radiation*water_vapor*max_temp,data=df2)
m <- lm(log10(tree_height)~annual_precip*solar_radiation*water_vapor*max_temp*temperature_average,data=df2) 
n <- lm(log10(tree_height)~annual_precip*solar_radiation*water_vapor*max_temp*temperature_average*min_temp*wind_speed,data=df2)
o <- lm(log10(tree_height)~annual_precip*solar_radiation*water_vapor*temperature_average*wind_speed,data=df2)
```

We then completed an Akaike's An Information Criterion on each of the linear models with the different predictors.
```{r}
AIC(i, j,k, l,m,n,o)
```

```{r}
summary(o)
```

```{r}
step(o)
```

We then filtered the data to complete with no NA's. 
```{r}
df3 <- filter(df2,!is.na(annual_precip))
```

We then ran the linear model. 
```{r}
model <- lm(log10(tree_height)~annual_precip*water_vapor*solar_radiation*temperature_average*wind_speed,data=df3)
```

We then predicted what the tree height would be using the linear model.
```{r}
df3$predicted_height<-predict(model)
```

We then put the predictions from the linear model back in spatial context. 
```{r}
z <- rasterize(x=cbind(df3$x,df3$y),y=tree_aus,
          field=df3$predicted_height,fun=mean)
```

We then plotted the logged predicted tree height of the linear model and the actual tree height. 
```{r}
plot(z)
plot(log10(tree_aus))
plot(tree_aus)
```

We then completed quantile regression on the same predictors used on the linear model.
```{r}
p_rq <- rq(log10(tree_height)~annual_precip*solar_radiation*water_vapor*temperature_average*wind_speed,data=df3, tau=0.9)
```

```{r}
AIC(p_rq)
```

```{r}
step(p_rq)
```

We then predicted what the tree height would be using the quantile regression model.
```{r}
df3$predicted_height<-predict(p_rq)
```

We then put the predictions from the linear model back in spatial context. 
```{r}
z_rq <- rasterize(x=cbind(df3$x,df3$y),y=tree_aus,
          field=df3$predicted_height,fun=mean)
```

We then plotted the predicted tree height of the quantile regression.
```{r}
plot(z_rq)
```

We then plotted the predicted tree height of the linear model, quantile regression and the actual tree height. All in meters. 
```{r}
par(mfrow=c(2,2))
plot(10^z, main="Linear model")
plot(10^z_rq, main="Quantile regression model")
plot(log10(tree_aus), main="Log10 of actual data")
plot(tree_aus, main="Actual data")
```

## Comparing the difference 
We then calculated the difference between the quantile regression to the linear model (log10)
```{r}
different <- z_rq - z
```

We then plotted the difference between the quantile regression to the linear model (log10). 
```{r}
plot(different)
```

We then calculated the difference between the not logged quantile regression to the actual tree height. 
```{r}
different2 <- 10^z_rq - tree_aus
```

We then plotted the difference between the not logged quantile regression to the actual tree height. 
```{r}
plot(different2)
```

```{r}
summary(p_rq)
```

need to work out the meter differences
then convert to years (2.7 meters per year)

